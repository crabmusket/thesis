\chapter{Models}
\label{ch:models}

This chapter introduces the various models used in both simulation of the system, and control.
\Autoref{sec:models:simulation} introduces the full nonlinear tank model which is used when running simulations.
\Autoref{sec:models:disturbances} introduces the method of generating predicted weather and user load profiles.
\Autoref{sec:models:control} outlines the linear state-space model of the stratified tank for MPC, and then describes the simplifying assumptions made to express the nonlinear simulation model as a linear model.
These sections all use the variables defined in \autoref{tab:model-symbols}.

\begin{table}
   \caption{Symbols used in model equations}
   \label{tab:model-symbols}
   \begin{center}
   \begin{tabular}{l l}
      \toprule
      $N$ & Number of nodes in the discretised tank model \\
      $T_i$ & Temperature of node $i$ in the water tank \\
      $T_c$ & Temperature of hot water from the collector entering the tank \\
      $T_x$ & Temperature of hot water from the auxiliary heater entering the tank \\
      $T_l$ & Temperature of the mains water entering the tank \\
      $T_a$ & Temperature of the air outside the tank \\
      $T_T$ & Target temperature for hot water inlets \\
      $\Q{*}$ & Energy inflow into tank node $i$ caused by * \\
      $\B{*}$ & Control/indicator function for flow * at node $i$ \\
      $C_i$ & Thermal capacitance of node $i$ \\
      $v_i$ & Volume of node $i$ \\
      $U_{s, i}$ & Surface conductivity of the tank at node $i$ \\
      \bottomrule
   \end{tabular}
   \end{center}
\end{table}

\section{Simulation model}
\label{sec:models:simulation}

A hot water tank is a complex nonlinear system when stratification is considered.
It is desirable to develop an accurate simulation of the system in order to test the validity of controllers designed with simplified models.

The popular multinode tank model, as discussed in \autoref{sec:review:stratified-tank-models}, treats the tank as a stack of identical vertical disks with their own heat flow equations.
I will reproduce this model, relying on the description in \textcite{Cristofari02} with my own augmentation to handle the auxiliary heater, which was not present in that work.
Note that this approach assumes stratification baffle devices are present on the solar and mains inputs into the tank, and that these devices work perfectly.

\subsection{Discretisation}

The tank is split into $N$ identical horizontal disks as illustrated in \autoref{fig:models:discretised-tank}, numbered $0$ (bottom) to $N-1$ (top).
Each disk, called a node, has uniform volume $v_i$.
The heat flows into the node, as shown in \autoref{fig:models:discretised-disk}, are governed by the equation:
\begin{equation}
   \label{eq:node-dT}
   \rho_i C_i v_i \dot{T}_i = \Q{amb} + \Q{mflow} + \Q{inlet}
\end{equation}
That is, the total energy flow through the node can be broken into three parts: ambient losses, changes from the mass flow through the tank while charging/drawing, and input from the three heat/cold inlet: the collector inlet, mains inlet, and auxiliary inlet.

\subsection{Heat flows}

The ambient term is a simple equation accounting for the surface area of an element and its current temperature relative to the exterior ambient temperature.
The parameter $U_{s, i}$ accounts for the different surface areas of the nodes at each end of the tank.
\begin{equation}
   \label{eq:Q-amb}
   \Q{amb} = U_{s, i} (T_a - T_i)
\end{equation}
The mflow energy flow accounts for the heat that enters and exits each node carried by the actual volume of water that flows through it.
As water is physically flowing through the tank during charging (hot water entering from the solar collector) and drawing (hot water exiting to the load), the composition of each node changes.
The factor $\dot{m}_i$, defined in \autoref{eq:mdot}, refers to the amount of water entering node $i$ from node $i+1$, the node above it, and is therefore positive when water is flowing downwards through the tank (in the direction of drawing).
\begin{equation}
   \label{eq:Q-mflow}
   \Q{mflow} = \max \left\{ 0, \dot{m}_i \right\}     C_i (T_{i+1} - T_i)
             + \min \left\{ 0, \dot{m}_{i-1} \right\} C_i (T_i - T_{i-1})
\end{equation}
We additionally define $\dot{m}_{N-1} = \dot{m}_{-1} = 0$ to handle the end cases.
Finally, the heat flow from each inlet is calculated in terms of its current mass flow and temperature.
$\Q{aux}$ represents the head gained due to the auxiliary input, which will be covered below.
\begin{equation}
   \label{eq:Q-inlet}
   \Q{inlet} = \B{col} \dot{m}_c (T_c - T_i)
             + \B{load} \dot{m}_l (T_l - T_i)
             + \Q{aux}
\end{equation}
where $\Q{aux}$ is the heat from the auxiliary input, defined below in \autoref{eq:Q-aux}.

\subsection{Control functions}

\Autoref{eq:Q-inlet} introduced the two \emph{control functions} $\B{col}$ and $\B{load}$ used by \authors{Cristofari02}, which are binary indicator functions that determine which nodes receive hot and cold water flows from the inlets.
These control functions simulate the hot and cold water from the collector and load passing through stratification devices as they enter the tank, so that they are distributed to the water layer which most appropriately matches their temperature.
They only ever return 1 for a single node in the tank.
They are defined as follows:
\begin{eqnarray}
   \label{eq:B-col}
   \B{col} &=& \begin{dcases*}
      1 & if $T_c > T_i$ and $i = N-1$ \\
      1 & if $T_{i+1} \ge T_c > T_i$ and $i < N-1$ \\
      0 & otherwise
   \end{dcases*}
   \\
   \label{eq:B-load}
   \B{load} &=& \begin{dcases*}
      1 & if $T_l < T_i$ and $i = 0$ \\
      1 & if $T_{i-1} \le T_l < T_i$ and $i > 0$ \\
      0 & otherwise
   \end{dcases*}
\end{eqnarray}
The mass flow through each node is defined by \authors{Cristofari02} using sums of these collector functions to express the presence of an inlet above/below the current node being examined as
\begin{equation}
	\label{eq:mdot}
   \dot{m}_i = \dot{m}_c \sum_{j=i+1}^{N-1} \B{col}
             - \dot{m}_l \sum_{j=1}^{i-1} \B{load}
             + \dot{m}_{\text{aux}, i}.
\end{equation}
$\dot{m}_{\text{aux}, i}$ represents the mass flow due to the auxiliary heating loop described in \autoref{eq:mdot-aux}.
Note again that the flow is positive in the direction of the collector loop (downwards).

\subsection{Auxiliary input}

\todo{This section needs to be rewritten because the new model works differently.}

In addition to the solar collector providing hot water to the tank, we wish to simulate an auxiliary heater, which in an actual system may be a gas burner, or an electric element connected to mains power.
For the purposes of our simulation we will treat this auxiliary heat as a second collector loop which draws water from the node $i = O$ (for outlet), heats it directly, and re-introduces it into the tank using the usual stratification mechanism.
The heating element has a fixed power rating $P$, but we are able to control the mass flow through the auxiliary water loop, $\dot{m}_x$.
The temperature of the water re-entering the tank after being heated is denoted by $T_x$.
It is calculated by assuming that the water drawn out of node $O$, $T_O$, is constant across the time interval we simulate over, and calculating the temperature gain given the heater's power rating:
\begin{equation}
	\label{eq:T-aux}
	T_x = T_O + \frac{P}{m_x * C_i}.
\end{equation}
Of course, this equation is only defined for $m_x \ne 0$.
In cases of zero flow through the auxiliary loop, this calculation is not performed.
The heat entering each node due to the auxiliary heater is given by
\begin{equation}
   \label{eq:Q-aux}
	\Q{aux} = \B{aux} \dot{m}_x (T_x - T_i),
\end{equation}
where $\B{aux}$, the auxiliary inlet's control function, is defined similarly to that of the collector (since both are treated as `hot' water):
\begin{equation}
   \label{eq:B-aux}
   \B{aux} = \begin{dcases*}
		0 & if $i < O$ \\
      1 & if $T_x > T_i$ and $i = N-1$ \\
      1 & if $T_{i+1} \ge T_x > T_i$ and $i < N-1$ \\
      0 & otherwise.
   \end{dcases*}
\end{equation}
Finally, we must define the mass flow through a node due to the operation of the auxiliary loop.
It is slightly more complex than the mass flows caused by the collector and load loops, because their outlets are fixed at the bottom and top of the tank respectively.
It is given by
\begin{equation}
   \label{eq:mdot-aux}
	\dot{m}_{\text{aux}, i} = \dot{m}_l \left( o_i - \sum_{j=1}^{i-1} \B{aux} \right)
\end{equation}
where $o_i$ is a binary factor that selects nodes above the auxiliary outlet:
$$
	o_i = \begin{dcases*}
		1 & if $i \ge O$ \\
		0 & otherwise.
   \end{dcases*}
$$

The Python source code implementing this tank model is found in \autoref{app:code:models:cristofari}.

\subsection{Collector input}

\todo{This section needs to be written.}
It works basically the same as the aux input.

\subsection{Model validity}

My implementation of the model was not verified against empirical data.
As this work focuses on comparing control strategies on the system, efforts were not made to ensure that physical parameters were realistic, only plausible.

\section{Stratified control model}
\label{sec:models:control}

\subsection{Simplifying assumptions}

When controlling a nonlinear system, it is possible to work with the full nonlinear model using software such as the ACADO control toolkit \textcite{ACADO}.
Such control algorithms may produce globally suboptimal control, depending on the problem.
However, ACADO in particular only works with smooth nonlinear functions.
The system model presented in \autoref{sec:models:simulation} is not smooth because of its use of binary indicator control functions (e.g. \autoref{eq:B-col}), and therefore is unsuitable for control by ACADO.
Therefore I have two options - revising the system model to be smoothly nonlinear, or revising it to be linear.

I chose to introduce simplifying assumptions to make the system linear by removing the necessity for the control functions $\B{*}$.
The control functions are responsible for selecting the position in the tank where entering water is deposited, and simulate the action of stratification devices as described in \autoref{sec:background:stratifiers}.
To eliminate these functions, it must be assumed that all water entry happens at fixed locations in the tank.
So, we will replace equations \ref{eq:B-col}, \ref{eq:B-load} and \ref{eq:B-aux} with
\begin{eqnarray}
   \label{eq:B-col'}  \B{col}'  =& 1 \text{ if } i = N-1, & 0 \text{ otherwise} \\
   \label{eq:B-load'} \B{load}' =& 1 \text{ if } i = 0,   & 0 \text{ otherwise} \\
   \label{eq:B-aux'}  \B{aux}'  =& 1 \text{ if } i = N-1, & 0 \text{ otherwise}
\end{eqnarray}
which mean that the hot inputs from the collector and auxiliary heater are fixed to enter at the top layer, and the cold water from the mains input will always enter at the bottom of the tank.

\todo{This paragraph should be rewritten.}
One further nonsmooth operation exists in \autoref{eq:Q-mflow}, where the min and max functions are used to express conditionality.
If net flow through a node is downwards, then it receives a temperature contribution from the node above it, and vice versa.
However, due to the changes introduced in the functions $\B{*}'$, we can simplify both the mass flow calculation and this heat calculation to remove any nonlinearity.
First, note that due to fixing the inlet positions, the total mass flow through the tank is now uniform:
\begin{equation}
   \label{eq:mdot'}
   \dot{m}_i' = \dot{m}_c - \dot{m}_l + \dot{m}_{\text{aux}},
\end{equation}
which shows that the total mass flow through all nodes is now uniform, since there is no dependence on $i$ (except, of course, for node $N-1$, whose mass flow is still 0 by definition).
Now, with the constraint that $\dot{m}_c, \dot{m}_l, \dot{m}_{\text{aux}} > 0$ since these are all physical pump rates that cannot be reversed, \autoref{eq:Q-mflow} can be rewritten:
\begin{equation}
   \Q{mflow}' =  (\dot{m}_c + \dot{m}_{\text{aux}}) C_i (T_{i+1} - T_i)
               +  \dot{m}_l                         C_i (T_i - T_{i-1})
\end{equation}
with obvious corrections at the top and bottom nodes.

What conditions are necessary to ensure these assumptions remain valid?
The control functions imply that if the temperature of water entering from the collector or heater is greater than the temperature at the top of the tank, then the water will entrer into the top node.
Therefore, is is required of the low-level pump controllers that they ensure all water from both the collector and the auxiliary heater must enter the tank at exactly temperature $T_T$.
This `target' temperature will be constant, and fixed during system design.
Therefore, the temperature at the top of the tank, $T_{N-1}$ will never exceed $T_T$ and these inlet flows will always enter at the top layer.

Similarly, if water from the mains is colder than the bottom layer of the tank, it will enter at the bottom.
To ensure this, place an additional constraint on the tank's controller that $T_0$ shall never fall below $T_l$, the mains water temperature, to ensure that water from the mains inlet always enters into the bottom node.

\todo{Mention internal controllers.
They will now be under external control, which removes them from the model, which is good, because they're nonlinear/nonsmooth.}

\section{Mixed-tank control model}

Efficient control using convex optimisation requires a linear model.
This is achieved by taking a very simplified view of the system used by \authors{Halvgaard12} and explained in \autoref{sec:review:mpc:halvgaard}.
The entire tank is described as a single temperature, taken to represent the average temperature of all layers.

\begin{equation}
	\label{eq:tdot-halvgaard}
	\dot{T} = \frac{-UA}{C}T + P \nu_x u +
		\left[ \begin{array}{cccc}
			\frac{-60}{C} & \frac{1}{C} & \\nu_c & frac{UA}{C}
		\end{array} \right] \left[ \begin{array}{c}
			m_l \\ T_l m_l \\ I \\ T_a
		\end{array} \right]
\end{equation}

\subsection{Linear state space model}

This is how we make a state-space model, consider the system as linear time-varying, but say it in a way that doesn't exclude the possibility that I might come up with other models, for example based on step response.
\todo{Fix these words.}
\begin{eqnarray}
   \label{eq:continuous-xdot}
   \dvec{x} &=& A(t) \vec{x} + B(t) \vec{u}, \\
   \label{eq:continuous-y}
   \vec{y} &=& C(t) \vec{x}
\end{eqnarray}
where $\vec{x}$ represents the state vector, $\vec{u}$ the input vector, $\vec{y}$ the output vector, and $t$ the current time.
From now, all $t$ arguments will be dropped for clarity; it is understood that all matrices may vary in time, and that $\dvec{x}$ and $\vec{y}$ are functions of time.
This system is discretised in the usual manner for linear state-space systems, assuming a zero-order hold on input signals between each time step, forming a new set of discrete-time equations
\begin{eqnarray}
   \label{eq:discretise-A}
   A_d &=& e^{A \delta t}, \\
   \label{eq:discretise-B}
   B_d &=& A^{-1} (A_d - I) B, \\
   \label{eq:discrete-xdot}
   \vec{x}_{t + \delta t} &=& A_d \vec{x} + B_d \vec{u},
\end{eqnarray}
though \autoref{eq:continuous-y} is unchanged.

In this simple model, we will include an explicit handling of `disturbance' inputs.
These refer to any system inputs which we do not have direct control over.
In the case of a water heating tank, disturbances include heat loss to the environment, heat contribution from solar collector, and the user load schedule.
Our only non-disturbance input is, of course, the electric heating element's state.

To make this distinction between disturbance and non-disturbance inputs, we decompose $B$ and $\vec{u}$ into
\begin{eqnarray}
   B &=& \left[\begin{array}{cc}
      B_u & B_d
   \end{array}\right], \\
   \vec{u} &=& \left[\begin{array}{c}
      \vec{u}_e \\ \vec{u}_d
   \end{array}\right]
\end{eqnarray}
where $\vec{u}_e$ represents our \emph{explicit} control signal to the system.
When $B$ is discretised according to \autoref{eq:discretise-B}, we can simply reconstruct the discretised $B_{u, d}$ and $B_{d, d}$ from the appropriate columns of $B_d$.

\autoref{eq:mpc-opt}
\todo{Diagram of $\hvec{y}, \vec{u}$ over planning horizon.}
This time horizon, $H$, is a unitless integer that determines how many time steps into the future the planning problem will consider.
We first define the output, input and disturbance vectors used in the planning problem, in terms of the time horizon:
\begin{eqnarray}
   \label{eq:mpc-vectors}
   \hvec{y} = \left[\begin{array}{c}
      \vec{y}_0 \\
      \vdots \\
      \vec{y}_H
   \end{array}\right],
   &
   \vec{u} = \left[\begin{array}{c}
      \vec{u}_0 \\
      \vdots \\
      \vec{u}_H
   \end{array}\right],
   & \text{and} \quad
   \hvec{d} = \left[\begin{array}{c}
      \vec{d}_0 \\
      \vdots \\
      \vec{d}_H
   \end{array}\right].
\end{eqnarray}
We can now define the matrices $\Psi$ and $\Theta$:
\begin{eqnarray}
   \label{eq:mpc-psi}
   \Psi &=& \left[\begin{array}{c}
      CA \\ CA^2 \\ \vdots \\ CA^H
   \end{array}\right]
   \\\label{eq:mpc-theta-u}
   \Theta_u &=& \left[\begin{array}{cccc}
      CB_u & 0 & 0 & 0 \\
      CAB_u & \ddots & 0 & 0 \\
      \vdots & \ddots & \ddots & 0 \\
      CA^{H-1}B_u & \cdots & CAB_u & CB_u
   \end{array}\right]
   \\\label{eq:mpc-theta-d}
   \Theta_d &=& \left[\begin{array}{cccc}
      CB_d & 0 & 0 & 0 \\
      CAB_d & \ddots & 0 & 0 \\
      \vdots & \ddots & \ddots & 0 \\
      CA^{H-1}B_d & \cdots & CAB_d & CB_d
   \end{array}\right]
   \\\label{eq:mpc-theta}
   \Theta &=& \left[\begin{array}{cc}
      \Theta_u & \Theta_d
   \end{array}\right]
\end{eqnarray}

\subsection{Matrix construction}

The vectors $\vec{u}_e$ and $\vec{u}_d$ are defined as follows:
\begin{eqnarray}
   \vec{u}_e &=& \left[\begin{array}{c} \dot{m}_{\text{aux}} \end{array} \right] \\
   \vec{u}_d &=& \left[\begin{array}{cccc} \dot{m}_c & \dot{m}_l & T_a & T_l \end{array} \right]
\end{eqnarray}

