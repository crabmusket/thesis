\chapter{Models}

\section{Controller models}

\subsection{Discrete-time state space model}

In this thesis, I develop several models, all based on a common structure.
The models are formulated as linear time-varying systems where at time $t$, the rate of change of the state $\dot{\vec{x}}_t$ depends on the current state $\vec{x}_t$, the input $\vec{u}_t$, and the disturbance $\vec{d}_t$, combined using matrices $A$, $B_u$ and $B_d$ which may all depend on $t$:
\begin{equation}
	\dot{\vec{x}}_t = A_t \vec{x}_t \times B_{u, t} \vec{u}_t \times B_{d, t} \vec{d}_t.
	\label{eq:xdot}
\end{equation}
This standard state-space model is discretised to a form appropriate for computer simulations assuming a zero-order hold on the input signal $\vec{u}$ between $\vec{u}_k$ and $\vec{u}_{k+1}$, resulting in new matrices $A_d, B_{du}$ and $B_{dd}$.
To discretise the two different $B$ matrices, we treat them as a single matrix $B$ with form
\begin{displaymath}
	B_t = \left[\begin{array}{cc}
		B_{u, t} & B_{d, t}
	\end{array}\right]
\end{displaymath}
and then use the usual method of discretising state-space systems with a period of $\delta t$,
\begin{eqnarray}
	A_{d, t} &=& e^{A_t \delta t}, \\
	B_{d, t} &=& A_t^{-1} (A_{d, t} - I) B_t.
\end{eqnarray}
We can then reconstruct the new $B_{ud, t}$ and $B_{dd, t}$ matrices from the appropriate columns of $B_{d, t}$.

\subsection{Control problem}

\todo{Diagram of $\hvec{y}, \hvec{u}$ over planning horizon.}
MPC controllers solve an optimisation problem at every instant in time to determine the next control input.
The form of this optimisation problem is, in general,
\begin{equation}
	\label{eq:mpc-opt}
	\optimise
		{minimise}{\hvec{u}}
		{f(\hvec{y}, \hvec{u})}
		{\hvec{y} = \Psi \vec{x}_0 + \Theta_u \hvec{u} + \Theta_d \hvec{d}}
\end{equation}
The controller attempts to minimise some objective function $f$ which usually processes the vector of outputs $\hvec{y}$ and inputs $\hvec{u}$ over the time horizon.
This time horizon, $H$, is a unitless integer that determines how many time steps into the future the planning problem will consider.
We first define the output, input and disturbance vectors used in the planning problem, in terms of the time horizon:
\begin{eqnarray}
	\label{eq:mpc-vectors}
	\hvec{y} = \left[\begin{array}{c}
		\vec{y}_0 \\
		\vdots \\
		\vec{y}_H
	\end{array}\right],
	&
	\hvec{u} = \left[\begin{array}{c}
		\vec{u}_0 \\
		\vdots \\
		\vec{u}_H
	\end{array}\right],
	& \text{and} \quad
	\hvec{d} = \left[\begin{array}{c}
		\vec{d}_0 \\
		\vdots \\
		\vec{d}_H
	\end{array}\right].
\end{eqnarray}
We can now define the matrices $\Psi$ and $\Theta$:
\begin{eqnarray}
	\label{eq:mpc-psi}
	\Psi &=& \left[\begin{array}{c}
		CA \\ CA^2 \\ \vdots \\ CA^H
	\end{array}\right]
	\\\label{eq:mpc-theta-u}
	\Theta_u &=& \left[\begin{array}{cccc}
		CB_u & 0 & 0 & 0 \\
		CAB_u & \ddots & 0 & 0 \\
		\vdots & \ddots & \ddots & 0 \\
		CA^{H-1}B_u & \cdots & CAB_u & CB_u
	\end{array}\right]
	\\\label{eq:mpc-theta-d}
	\Theta_d &=& \left[\begin{array}{cccc}
		CB_d & 0 & 0 & 0 \\
		CAB_d & \ddots & 0 & 0 \\
		\vdots & \ddots & \ddots & 0 \\
		CA^{H-1}B_d & \cdots & CAB_d & CB_d
	\end{array}\right]
\end{eqnarray}

\subsection{Halvgaard mixed-tank model}
\label{sec:model:halvgaard}

\section{Simulator models}

\subsection{Stratified tank model}

Model the water tank as a perfect cylinder of height $h$ and radius $r$.
Divide the tank into $N$ vertical slices with an equal fixed height (and therefore fixed volume $V = \pi r^2 \frac{h}{N}$).
Define $T_1 .. T_N$ as the temperatures of each slice.
Define $\dot{m}_c$ and $\dot{m}_l$ as the mass flows through the collector and load circuits respectively.
The mass flows are `positive clockwise' as viewed on the diagram (collector flow enters at top, load flow at bottom).
Define $\dot{m}_{m, i}$ as the mass flow through each node (positive downwards) which takes into account the mass flow through node $i$ given the behavior of the collector and load functions.
$$ \dot{m}_{m, i} = \dot{m}_c \sum _{j=1} ^{i-1} B^j_c - \dot{m}_l \sum _{j=i+1} ^N B^j_l $$

